name: Vercel Custom Domain Alias (Preview)

on:
  push:
    # This workflow is intentionally scoped to this branch, per request.
    branches:
      - cursor/vercel-custom-domain-deployment-d8d2
  workflow_dispatch:
    inputs:
      deployment_url:
        description: "Optional: exact Vercel deployment host (e.g. foo-git-branch-org.vercel.app)"
        required: false
        default: ""
      custom_domain:
        description: "Optional: custom domain to alias to (defaults to secret VERCEL_CUSTOM_DOMAIN)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  alias:
    name: Alias deployment to custom domain
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate required Vercel secrets
        run: |
          missing=0
          for v in VERCEL_TOKEN VERCEL_PROJECT_ID VERCEL_CUSTOM_DOMAIN; do
            if [ -z "${!v}" ]; then
              echo "::error::Missing required secret/env: $v"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            echo ""
            echo "Add these as GitHub Action secrets (repo Settings → Secrets and variables → Actions):"
            echo "  - VERCEL_TOKEN"
            echo "  - VERCEL_PROJECT_ID"
            echo "  - VERCEL_CUSTOM_DOMAIN"
            echo "Optional:"
            echo "  - VERCEL_TEAM_ID"
            exit 1
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_CUSTOM_DOMAIN: ${{ github.event.inputs.custom_domain || secrets.VERCEL_CUSTOM_DOMAIN }}

      - name: Alias latest deployment to custom domain
        run: npx tsx scripts/vercel/alias-preview.ts
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          VERCEL_CUSTOM_DOMAIN: ${{ github.event.inputs.custom_domain || secrets.VERCEL_CUSTOM_DOMAIN }}
          VERCEL_DEPLOYMENT_URL: ${{ github.event.inputs.deployment_url }}

